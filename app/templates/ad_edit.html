{% extends "base.html" %}

{% block title %}Anzeige bearbeiten{% endblock %}

{% block content %}
<h1>Anzeige bearbeiten</h1>

<form action="{{ url_for('ad_edit', ad_id=ad.ad_id) }}" 
      method="post" 
      enctype="multipart/form-data"
      class="ad-edit-form">

  <!-- Basic Infos der Anzeige -->
  <fieldset>
    <legend>Anzeigen-Infos</legend>

    <div class="form-row">
      <label for="titel">Titel</label>
      <input type="text" id="titel" name="titel" value="{{ ad.titel }}" required>
    </div>

    <div class="form-row">
      <label for="text">Beschreibung</label>
      <textarea id="text" name="text" rows="6" required>{{ ad.text }}</textarea>
    </div>

    <div class="form-row">
      <label for="preis">Preis</label>
      <input 
        type="number" 
        step="0.01" 
        id="preis" 
        name="preis" 
        value="{{ ad.preis if ad.preis is not none }}"
        placeholder="z.B. 49.99">
    </div>

    <div class="form-row">
      <label for="status">Status</label>

      {# Admin/redakteur -> immer dropdown Auswahl
      regular user NUR, wenn die Anzeige nicht mehr pending ist #}
      {% if rolle in ['admin', 'redakteur'] or ad.status != 'pending' %}
      <select id="status" name="status">
        <option value="aktiv"      {{ "selected" if ad.status == "aktiv" }}>Aktiv</option>
        <option value="reserviert" {{ "selected" if ad.status == "reserviert" }}>Reserviert</option>
        <option value="verkauft"   {{ "selected" if ad.status == "verkauft" }}>Verkauft</option>
        <option value="archiviert" {{ "selected" if ad.status == "archiviert" }}>Archiviert</option>
      </select>
      {% else %}
      {# normaler user + pending -> status nur anzeigen, aber nicht ändern#}
      <p>{{ ad.status|capitalize }}</p>
      {% endif %}
    </div>
  </fieldset>

  <fieldset>
    <legend>KAtegorien</legend>

    {% if categories %}
        {% for cat in categories %}
            <label>
                <input
                    type="checkbox"
                    name="categories"
                    value="{{ cat.category_id }}"
                    {% if cat.category_id in selected_category_ids %}checked{% endif %}
                    >
                {{ cat.name }}
            </label><br>
        {% endfor %}
    {% else %}
            <p><em>Keine Kategorien vorhanden.</em></p>
    {% endif %}
  </fieldset>

  <!-- Vorhandene Bilder verwalten -->
  <fieldset class="images-existing">
    <legend>Vorhandene Bilder</legend>

    {% if images %}
      <div class="image-grid">
        {% for image in images %}
          <div class="image-item">
            {# 
              file_path ist z.B. "static/uploads/xyz.jpg".
              / davor ergibt dann "/static/uploads/xyz.jpg" 
            #}
            <img src="/{{ image.file_path }}" alt="Bild {{ loop.index }}" class="thumb">

            <div class="image-meta">
              <span>Bild #{{ loop.index }}</span>
              <label>
                <input type="checkbox" 
                       name="delete_images" 
                       value="{{ image.image_id }}">
                Dieses Bild löschen
              </label>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p>Es sind aktuell keine Bilder hinterlegt.</p>
    {% endif %}
  </fieldset>

  <!-- Neue Bilder hinzufügen -->
  <fieldset class="images-new">
    <legend>Neue Bilder hinzufügen</legend>

    <div class="form-row">
      <label for="images">Weitere Bilder hochladen</label>
      <input type="file" 
             id="images" 
             name="images" 
             accept="image/*" 
             multiple>
      <p class="hint">
        Du kannst mehrere Bilder auswählen. Erlaubte Formate: PNG, JPG, JPEG, GIF.
      </p>
    </div>
  </fieldset>

  <div class="form-actions">
    <button type="submit">Änderungen speichern</button>
    <a href="{{ url_for('my_ads', ad_id=ad.ad_id) }}" class="button-secondary">
      Abbrechen
    </a>
  </div>
</form>

{% endblock %}
