{% extends "base.html" %}

{% block content %}
  {# Cover-Pfad einmal zentral setzen #}
  {% set cover_path = ad.bilder_path %}

  <div class="ad-detail-page">

    <aside class="sidebar">
      <h3>Kategorien</h3>
      <ul>
        {% for cat in categories %}
          <li>
            <a href="{{ url_for('ads_by_category', category_id=cat.category_id) }}">
              {{ cat.name }}
            </a>
          </li>
        {% endfor %}
      </ul>
    </aside>

    <main class="ad-detail">
      <h1>{{ ad.titel }}</h1>

      {% if ad.preis is not none %}
        <p class="price">{{ "%.2f"|format(ad.preis|float) }} â‚¬</p>
      {% else %}
        <p class="price">Preis: n. V.</p>
      {% endif %}

      <p class="owner">
        Anbieter: {{ ad.vorname }} {{ ad.nachname }}<br>
        E-Mail: {{ ad.email }}
      </p>

      {# Block Kontaktaufnahme #}
      {% if session.get('user_id') and session.get('user_id') != ad.owner_id %}
        <section class=""ad-contact">
          <h2>Kontaktiere mich</h2>
          <form action="{{ url_for('message_thread', ad_id=ad.ad_id, other_user_id=ad.owner_id) }}" method="post">
            <textarea name="body" rows="3" required placeholder="Ihre Nachricht..."></textarea>
            <button type="submit">Nachricht senden</button>
          </form>
        </section>
      {% endif %}

      {# Coverbild #}
      {% if cover_path %}
        {% set clean_cover = cover_path.replace('static/', '') %}
        <div class="cover-image">
          <img src="{{ url_for('static', filename=clean_cover) }}"
               alt="Bild zu {{ ad.titel }}">
        </div>
      {% endif %}

      {# Galerie ohne Coverbild #}
      {% if images %}
        <div class="ad-gallery">
          {% for img in images %}
            {% if not cover_path or img.file_path != cover_path %}
              {% set clean_path = img.file_path.replace('static/', '') %}
              <img src="{{ url_for('static', filename=clean_path) }}"
                   alt="Bild {{ loop.index }} zu {{ ad.titel }}">
            {% endif %}
          {% endfor %}
        </div>
      {% endif %}

      {# Kategorien-Badges der Anzeige #}
      {% if ad.categories %}
        <div class="ad-categories">
          {% for cat in ad.categories %}
            <span class="badge">
              <a href="{{ url_for('ads_by_category', category_id=cat.category_id) }}">
                {{ cat.name }}
              </a>
            </span>
          {% endfor %}
        </div>
      {% endif %}

      <article class="ad-text">
        <p>{{ ad.text }}</p>
      </article>

      <p class="ad-meta">
        Eingestellt am {{ ad.datum }}
      </p>
    </main>

  </div>
{% endblock %}
